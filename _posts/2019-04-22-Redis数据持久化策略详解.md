---
layout:     post
title:      文章拿在手 Redis 面试不用愁（一）
subtitle:   Redis 数据持久化策略详解
date:       2019-04-19
author:     Alessio
header-img: img/PostBack_03.jpg
catalog: true
tags:
    - Redis
---
## 从持久化开始
我们在开发中不止一次地碰到过数据持久化这个名词，我们不厌其烦地再解释一遍
>
> 持久化，本质上来说，是一种将程序数据在持久状态和瞬时状态间转换的机制
>
持久化的应用场景有很多，在不同场景下其含义也不相同，在 Redis 里我们大可以把 持久化 看作是 数据从内存中转存到磁盘上的过程。

**持久化能够解决因为进程退出而造成的数据丢失（不一致）问题**

Redis 作为内存数据存储，对于数据持久化机制的实现也提供了两种不同的思路，及我们即将谈到的 `RDB` 和 `AOF`

## RDB
RDB 持久化机制，可以通过手动或自动触发

### 手动 RDB
手动触发 RDB 需要两个关键命令 `save` 和 `bgsave`。

#### `save`命令
`save` 命令会立刻开始 RDB 过程，将内存中的数据转移到磁盘上，在这个过程中，RDB 操作会阻塞当前主进程——在这个时候，你的 Redis 就进入“假死” 状态了。

在这个过程中，主进程将不会对外服务，而且对于比较大的实例来说，这个过程耗费的时间略长，线上环境一般是不采用的。

在 RDB 操作结束后，主进程不再被阻塞，生成的 .rdb 数据文件会按照配置文件中的 `dir` 配置保存妥当，文件名则通过 `dbfilename` 配置来指定
#### `bgsave` 命令

`bgsave` 相对则会 “温柔些” 。在执行 `bgsave` 命令时，主进程会执行 fork 操作创建一个子进程，由这个进程来完成 RDB 操作。

在这个过程中，由于使用了子进程，所以不会阻塞主进程——你的 Redis 不会“假死”啦~

同样的，新生成的 `.rdb` 文件也会按照相应的配置完成 “安家落户”。

### 自动 RDB

自动 RDB 首先会**基于配置**来决定要不要执行自动配置 如下配置文件示例：

```bash
################################ SNAPSHOTTING  ################################
#
# Save the DB on disk:
#
#   save <seconds> <changes>
#
#   Will save the DB if both the given number of seconds and the given
#   number of write operations against the DB occurred.
#
#   In the example below the behaviour will be to save:
#   after 900 sec (15 min) if at least 1 key changed
#   after 300 sec (5 min) if at least 10 keys changed
#   after 60 sec if at least 10000 keys changed
#
#   Note: you can disable saving completely by commenting out all "save" lines.
#
#   It is also possible to remove all the previously configured save
#   points by adding a save directive with a single empty string argument
#   like in the following example:
#
#   save ""

save 900 1
save 300 10
save 60 10000
```
第二种情况，如果在主从复制的场景下，**新的从节点加入**，或者 **从节点执行全量复制操作**，主节点会自动执行 `bgsave` 生成 RDB 文件并分发给从节点

第三种情况，当执行 `debug reload` 命令，重新加载 Redis 时，也会触发 `save` 操作 

第四种情况，当我们使用 `redis-cli -p <port> shutdown` 命令来关闭 Redis 的时候，如果没有开启 AOF 持久化，那么也会默认执行 `bgsave` 操作

### 关于 RDB 文件

1. RDB 文件默认通过 `LZF 算法` 来完成压缩处理，方便网络传输或保存到磁盘上
2. 如果之前存在 RDB 文件， 新产生的 RDB 文件会**原子**地替换掉旧的 RDB 文件
3. 如果在 bgsave 命令仍在执行时重新发送 besave 命令，Redis 会直接返回该命令
4. 其实在 bgsave 的时候，也会在 fork 操作的时候阻塞主进程，但是其时间消耗几乎可忽略不计
5. 可使用 官方工具 `redis-check-dump` 来对 RDB 文件进行检测

## AOF
### AOF 介绍
#### AOF 缓冲区
### AOF 重写
#### AOF 重写缓冲区
### 多实例情况下的 AOF
