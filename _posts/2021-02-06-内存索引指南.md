---
layout:     post
title:      数据库内核月报拾遗
subtitle:   cloud
date:       2021-02-06
author:     Zjianru
header-img: img/post-bg-desk.jpg
catalog: true
tags:
    - dataBase
---
## 背景

**如何选择内存索引结构，是设计和优化数据库时的关键问题**

对于内存数据库，内存索引是读写路径上的核心结构

对于磁盘数据库，在服务器内存足以缓存绝大部分热数据的场景下，内存索引可以大幅加速热数据的读写

内存索引结构的种类非常多，没有那种索引能够实现在任何一方面领先，在选择时需要根据不同的场景进行权衡

`ART` 在不同数据量大小的场景下的点查询表现最佳，剖析后认为原因如下：

- 数据结构自身查找性能的差距

字典树的查找开销是常量级的 O(k) 但是搜索树的查找开销是 O(LogN)

在较为理想的情况下，一个朴素的字典树，每一层对应 key 中一个位置的字节，考虑每个节点的扇出最高是 256 ，最少只需要搜索 4 层即可覆盖超过 40 亿个 key 的索引空间
计算开销和访存开销都很低

- 使用自适应的节点格式，并在不同的节点格式中使用不同的查找方式

字典树中的不同节点可能有不同的扇出，ART 共有四种不同的节点格式：Node4、Node16、Node48、Node256 ，分别存储不同删除的节点

这样设计有两个好处：

```bash
1. 提高缓存效率。
针对扇出较小的节点，如果统一使用包含256个指针的节点，可能会有较多的空闲空间
如果使用变长的节点形式，内存分配过程中可能会产生大量的内存碎片
采用不同格式的节点，并预分配固定的空间，可以在节省内存的同时降低写入时内存分配的开销、减少内存碎片
2. 可以根据不同格式的节点选择最优的查询方式
除了 Node256 可以直接通过下标找到子节点的指针外，其他节点的查询都需要额外开销，这里针对不同格式的节点，选择了合适的查询方式
对于 Node4，节点中最多存储 4 个字符和 4 个指针，因为数据量小，只需要顺序遍历即可
对于 Node16，节点中最多存储 16 个字符和 16 个指针，可以使用 SIMD 指令集，在几个 CPU cycle 内并行比较节点包含的所有字符，找出子节点的指针
对于 Node48，节点中使用一个长度 256 的 uint8 数组和最多存储 48 个指针，uint8 数组作为一个 HashMap ，将字符映射到指针数组中的对应位置
```
